# ë®¨ì„¸ì ì£¼ ë°±ì—”ë“œ Makefile
# í…ŒìŠ¤íŠ¸, ê°œë°œ, ë°°í¬ ê´€ë ¨ ì‘ì—…ì„ ìë™í™”í•©ë‹ˆë‹¤.

# ë³€ìˆ˜ ì •ì˜
PYTHON := uv run python
PYTEST := uv run pytest
MANAGE := $(PYTHON) manage.py
PROJECT_NAME := myunsejeomju-backend

# ê¸°ë³¸ ì„¤ì •
.DEFAULT_GOAL := help
.PHONY: help install test lint format clean dev build docker

# ë„ì›€ë§ í‘œì‹œ
help: ## ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´ ëª©ë¡ì„ í‘œì‹œí•©ë‹ˆë‹¤
	@echo "$(PROJECT_NAME) - ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:"
	@echo
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo

# ê°œë°œ í™˜ê²½ ì„¤ì •
install: ## í”„ë¡œì íŠ¸ ì˜ì¡´ì„±ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤
	@echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
	uv sync --frozen
	@echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ!"

install-dev: ## ê°œë°œìš© ì˜ì¡´ì„±ì„ í¬í•¨í•˜ì—¬ ì„¤ì¹˜í•©ë‹ˆë‹¤
	@echo "ğŸ“¦ ê°œë°œìš© ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
	uv sync --frozen --extra dev --extra test
	@echo "âœ… ê°œë°œìš© ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ!"

install-test-deps: ## í…ŒìŠ¤íŠ¸ ì˜ì¡´ì„±ë§Œ ì„¤ì¹˜í•©ë‹ˆë‹¤
	@echo "ğŸ“¦ í…ŒìŠ¤íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
	uv sync --frozen --extra test
	@echo "âœ… í…ŒìŠ¤íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ!"

# ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨
migrate: ## ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "ğŸ”„ ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ì¤‘..."
	$(MANAGE) migrate
	@echo "âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ!"

makemigrations: ## ìƒˆë¡œìš´ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ìƒì„±í•©ë‹ˆë‹¤
	@echo "ğŸ“ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„± ì¤‘..."
	$(MANAGE) makemigrations
	@echo "âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„± ì™„ë£Œ!"

seed: ## í…ŒìŠ¤íŠ¸ìš© ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
	@echo "ğŸŒ± ì‹œë“œ ë°ì´í„° ìƒì„± ì¤‘..."
	$(MANAGE) seed_data
	$(MANAGE) seed_tables
	@echo "âœ… ì‹œë“œ ë°ì´í„° ìƒì„± ì™„ë£Œ!"

# í…ŒìŠ¤íŠ¸ ê´€ë ¨
test: install-test-deps ## ëª¨ë“  í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "ğŸ§ª ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	$(PYTEST) -v
	@echo "âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"

test-unit: install-test-deps ## ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "ğŸ”§ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	$(PYTEST) -v -m unit
	@echo "âœ… ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"

test-integration: install-test-deps ## í†µí•© í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "ğŸ”— í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	$(PYTEST) -v -m integration
	@echo "âœ… í†µí•© í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"

test-concurrency: install-test-deps ## ë™ì‹œì„± í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "âš¡ ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	$(PYTEST) -v -m concurrency
	@echo "âœ… ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"

test-fast: install-test-deps ## ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰í•©ë‹ˆë‹¤ (slow ë§ˆì»¤ ì œì™¸)
	@echo "ğŸš€ ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	$(PYTEST) -v -m "not slow"
	@echo "âœ… ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"

test-parallel: install-test-deps ## ë³‘ë ¬ë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "âš¡ ë³‘ë ¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	$(PYTEST) -v -n auto
	@echo "âœ… ë³‘ë ¬ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"

test-coverage: install-test-deps ## ì½”ë“œ ì»¤ë²„ë¦¬ì§€ë¥¼ ì¸¡ì •í•˜ë©° í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "ğŸ“Š ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ì¸¡ì • ì¤‘..."
	$(PYTEST) -v --cov=domain --cov=infrastructure --cov=presentation \
		--cov-report=html --cov-report=term-missing
	@echo "âœ… ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ê°€ htmlcov/ ë””ë ‰í† ë¦¬ì— ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
	@echo "ë¸Œë¼ìš°ì €ì—ì„œ htmlcov/index.htmlì„ ì—´ì–´ í™•ì¸í•˜ì„¸ìš”."

test-watch: install-test-deps ## íŒŒì¼ ë³€ê²½ ì‹œ ìë™ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "ğŸ‘€ í…ŒìŠ¤íŠ¸ ê°ì‹œ ëª¨ë“œ ì‹œì‘..."
	$(PYTEST) -v --looponfail

# íŠ¹ì • í…ŒìŠ¤íŠ¸ ì‹¤í–‰
test-repo: ## Repository í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "ğŸ—ƒï¸ Repository í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	$(PYTEST) -v tests/unit/test_repositories.py
	@echo "âœ… Repository í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"

test-usecase: ## Use Case í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "ğŸ’¼ Use Case í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	$(PYTEST) -v tests/unit/test_use_cases.py
	@echo "âœ… Use Case í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"

test-api: ## API í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "ğŸŒ API í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	$(PYTEST) -v tests/integration/test_api_orders.py
	@echo "âœ… API í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"

# ì½”ë“œ í’ˆì§ˆ
lint: ## ì½”ë“œ í’ˆì§ˆì„ ê²€ì‚¬í•©ë‹ˆë‹¤
	@echo "ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì¤‘..."
	$(PYTHON) -m flake8 domain infrastructure presentation
	@echo "âœ… ë¦°íŠ¸ ê²€ì‚¬ ì™„ë£Œ!"

format: ## ì½”ë“œ í¬ë§·íŒ…ì„ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "ğŸ¨ ì½”ë“œ í¬ë§·íŒ… ì¤‘..."
	$(PYTHON) -m black domain infrastructure presentation tests
	$(PYTHON) -m isort domain infrastructure presentation tests
	@echo "âœ… ì½”ë“œ í¬ë§·íŒ… ì™„ë£Œ!"

type-check: ## íƒ€ì… ê²€ì‚¬ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "ğŸ”¬ íƒ€ì… ê²€ì‚¬ ì¤‘..."
	$(PYTHON) -m mypy domain infrastructure presentation
	@echo "âœ… íƒ€ì… ê²€ì‚¬ ì™„ë£Œ!"

# ê°œë°œ ì„œë²„
dev: ## ê°œë°œ ì„œë²„ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "ğŸš€ ê°œë°œ ì„œë²„ ì‹œì‘..."
	$(MANAGE) runserver

dev-shell: ## Django ì…¸ì„ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "ğŸš Django ì…¸ ì‹œì‘..."
	$(MANAGE) shell

# ì •ë¦¬ ì‘ì—…
clean: ## ìºì‹œ íŒŒì¼ë“¤ì„ ì •ë¦¬í•©ë‹ˆë‹¤
	@echo "ğŸ§¹ ìºì‹œ íŒŒì¼ ì •ë¦¬ ì¤‘..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	rm -rf .pytest_cache/
	rm -rf htmlcov/
	rm -rf .coverage
	@echo "âœ… ì •ë¦¬ ì™„ë£Œ!"

clean-db: ## SQLite ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤
	@echo "ğŸ—‘ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì‚­ì œ ì¤‘..."
	rm -f db.sqlite3
	@echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ ì‚­ì œ ì™„ë£Œ!"

reset-db: clean-db migrate seed ## ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì´ˆê¸°í™”í•˜ê³  ì‹œë“œ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
	@echo "ğŸ”„ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ!"

# Docker ê´€ë ¨
docker-build: ## Docker ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤
	@echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
	docker build -t $(PROJECT_NAME) .
	@echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ!"

docker-up: ## Docker Composeë¡œ ì„œë¹„ìŠ¤ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤
	@echo "ğŸ³ Docker ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."
	docker-compose up -d
	@echo "âœ… Docker ì„œë¹„ìŠ¤ ì‹œì‘ ì™„ë£Œ!"

docker-down: ## Docker Compose ì„œë¹„ìŠ¤ë¥¼ ì¤‘ì§€í•©ë‹ˆë‹¤
	@echo "ğŸ³ Docker ì„œë¹„ìŠ¤ ì¤‘ì§€ ì¤‘..."
	docker-compose down
	@echo "âœ… Docker ì„œë¹„ìŠ¤ ì¤‘ì§€ ì™„ë£Œ!"

docker-logs: ## Docker ì„œë¹„ìŠ¤ ë¡œê·¸ë¥¼ í™•ì¸í•©ë‹ˆë‹¤
	docker-compose logs -f

# ì¢…í•© í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸
test-all: test-unit test-integration test-concurrency ## ëª¨ë“  íƒ€ì…ì˜ í…ŒìŠ¤íŠ¸ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "ğŸ‰ ì „ì²´ í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ ì™„ë£Œ!"

# ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
test-performance: ## ì„±ëŠ¥ ê´€ë ¨ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "âš¡ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	$(PYTEST) -v -m "slow or concurrency" --durations=10
	@echo "âœ… ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"

# ê°œë°œì ì›Œí¬í”Œë¡œìš°
dev-setup: install-dev migrate seed ## ê°œë°œ í™˜ê²½ì„ ì™„ì „íˆ ì„¤ì •í•©ë‹ˆë‹¤
	@echo "ğŸ¯ ê°œë°œ í™˜ê²½ ì„¤ì • ì™„ë£Œ!"
	@echo "ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ê°œë°œ ì„œë²„ë¥¼ ì‹œì‘í•˜ì„¸ìš”: make dev"

# ë°°í¬ ì¤€ë¹„
build: clean format lint test ## ë°°í¬ ì¤€ë¹„ë¥¼ ìœ„í•œ ì „ì²´ ë¹Œë“œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "ğŸš€ ë¹Œë“œ ì™„ë£Œ! ë°°í¬ ì¤€ë¹„ê°€ ëë‚¬ìŠµë‹ˆë‹¤."